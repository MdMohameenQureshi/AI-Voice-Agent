<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI VA - TTS Integration Demo</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 850px;
            margin: 0 auto;
            padding: 15px;
            background: #f8f9fa;
            line-height: 1.6;
            color: #333;
        }
        .container {
            background: white;
            padding: 25px 35px;
            border-radius: 8px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
            border: 1px solid #e0e0e0;
        }
        h1 {
            color: #2c3e50;
            text-align: left;
            font-weight: 600;
            margin-bottom: 8px;
        }
        .tts-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }
        .tts-section h2 {
            color: #2c3e50;
            margin-bottom: 12px;
            font-weight: 500;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #2c3e50;
            font-size: 14px;
        }
        #ttsInput {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 4px;
            font-size: 15px;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.2s;
            background: white;
            color: #333;
        }
        #ttsInput:focus {
            outline: none;
            border-color: #007acc;
        }
        #generateSpeechBtn {
            background: #007acc;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            font-size: 15px;
            cursor: pointer;
            transition: background 0.2s;
            margin-top: 8px;
        }
        #generateSpeechBtn:hover {
            background: #005a99;
        }
        #generateSpeechBtn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }
        #ttsResult {
            margin-top: 20px;
            padding: 20px;
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 5px;
        }
        #ttsResult h3 {
            color: #155724;
            margin-top: 0;
        }
        #audioInfo {
            color: #155724;
            font-size: 14px;
            margin-top: 10px;
        }
        .error {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 5px;
            color: #721c24;
        }
        
        /* Audio Features Section */
        .audio-features-section {
            margin-top: 25px;
            padding: 20px;
            background: #f0f8ff;
            border-radius: 6px;
            border-left: 4px solid #007acc;
        }
        
        /* TTS Section */
        .tts-subsection {
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }
        
        .tts-subsection h2 {
            color: #2c3e50;
            margin-bottom: 12px;
            font-size: 1.4rem;
            font-weight: 500;
        }
        
        /* Voice Recording Section */
        .echo-subsection {
            padding: 20px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
        }
        
        .echo-subsection h2 {
            color: #2c3e50;
            margin-bottom: 12px;
            font-size: 1.4rem;
            font-weight: 500;
        }
        
        .recording-controls {
            display: flex;
            gap: 12px;
            margin: 15px 0;
            align-items: center;
        }
        
        .record-btn {
            padding: 10px 18px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }
        
        .start-record {
            background: #007acc;
            color: white;
        }
        
        .start-record:hover {
            background: #005a99;
        }
        
        .stop-record {
            background: #e74c3c;
            color: white;
        }
        
        .stop-record:hover {
            background: #c0392b;
        }
        
        .record-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }
        
        .recording-status {
            text-align: center;
            margin: 15px 0;
            font-size: 1.1rem;
        }
        
        .recording-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            background-color: #dc3545;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; }
        }
        
        .playback-section {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
            border-left: 3px solid #007acc;
        }
        
        .playback-section h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.1rem;
            font-weight: 500;
        }
        
        #ttsResult {
            margin-top: 15px;
            padding: 15px;
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 4px;
        }
        #ttsResult h3 {
            color: #155724;
            margin-top: 0;
            font-size: 1.1rem;
            font-weight: 500;
        }
        #audioInfo {
            color: #2c3e50;
            font-size: 13px;
            margin-top: 8px;
        }
        .error {
            margin-top: 15px;
            padding: 12px;
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1> Voice Generator</h1>
        <!-- <p>Hey there! This is a little demo I put together to show off some cool voice features. You can turn text into speech or record your own voice - pretty neat stuff!</p> -->
        
        <!-- Combined Audio Features Section -->
        <div class="audio-features-section">
            <!-- Text-to-Speech Subsection -->
            <div class="tts-subsection">
                <h2>üí¨ Text to Speech</h2>
                <!-- <p>Type something and I'll make it talk! Works pretty well most of the time.</p> -->
                
                <div class="form-group">
                    <label for="ttsInput">What should I say?</label>
                    <textarea id="ttsInput" placeholder="Type anything you want to hear..." rows="3">Hey! This text-to-speech thing actually works.</textarea>
                </div>
                
                <button id="generateSpeechBtn" onclick="generateSpeech()">Make it Talk!</button>
                
                <div id="ttsLoading" style="display: none;">
                    <p>‚è≥ Working on it...</p>
                </div>
                
                <div id="ttsResult" style="display: none;">
                    <h3>Here's your audio!</h3>
                    <audio id="audioPlayer" controls style="width: 100%; margin: 10px 0;">
                        Your browser does not support the audio element.
                    </audio>
                    <p id="audioInfo"></p>
                </div>
                
                <div id="ttsError" style="display: none;" class="error">
                    <p id="errorMessage"></p>
                </div>
            </div>
            
            <!-- Echo Bot Subsection -->
            <div class="echo-subsection">
                <h2> Voice Recorder</h2>
                <!-- <p>Record yourself and hear it back - like a digital echo! Pretty cool, right?</p> -->
                
                <div class="recording-controls">
                    <button id="startRecordBtn" class="record-btn start-record" onclick="startRecording()">
                        üé§ Start Recording
                    </button>
                    <button id="stopRecordBtn" class="record-btn stop-record" onclick="stopRecording()" disabled>
                        ‚èπÔ∏è Stop
                    </button>
                </div>
                
                <div id="recordingStatus" class="recording-status" style="display: none;">
                    <span class="recording-indicator"></span>
                    Recording in progress...
                </div>
                
                <div id="playbackSection" class="playback-section" style="display: none;">
                    <h3>üîä Here's what you said</h3>
                    <audio id="recordedAudio" controls style="width: 100%; max-width: 400px;">
                        Your browser does not support the audio element.
                    </audio>
                    
                    <!-- Upload Status Section -->
                    <div id="uploadStatus" style="margin-top: 10px; padding: 10px; border-radius: 4px; display: none;">
                        <p id="uploadMessage" style="margin: 0; font-size: 14px;"></p>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <button id="playRecordingBtn" class="record-btn start-record" onclick="playRecording()" style="font-size: 14px; padding: 8px 16px; min-width: auto;">
                            ‚ñ∂Ô∏è Play Recording
                        </button>
                        <button id="uploadBtn" class="record-btn" onclick="uploadRecording()" style="background: #007acc; font-size: 14px; padding: 8px 16px; min-width: auto; margin-left: 10px;">
                            ‚òÅÔ∏è Upload to Server
                        </button>
                    </div>
                    <p style="margin-top: 10px; color: #666; font-size: 0.9rem;">
                        Duration: <span id="recordingDuration">0:00</span> | 
                        Size: <span id="recordingSize">0 KB</span>
                    </p>
                </div>
                
                <div id="echoError" style="display: none;" class="error">
                    <p id="echoErrorMessage"></p>
                </div>
            </div>
        </div>
    </div>
    <script src="/static/script.js"></script>
    <script>
        async function generateSpeech() {
            const textInput = document.getElementById('ttsInput');
            const button = document.getElementById('generateSpeechBtn');
            const loading = document.getElementById('ttsLoading');
            const result = document.getElementById('ttsResult');
            const error = document.getElementById('ttsError');
            const audioPlayer = document.getElementById('audioPlayer');
            const audioInfo = document.getElementById('audioInfo');
            const errorMessage = document.getElementById('errorMessage');
            
            const text = textInput.value.trim();
            
            if (!text) {
                showError('You need to type something first!');
                return;
            }
            
            // Reset UI
            hideAllResults();
            button.disabled = true;
            button.textContent = 'Creating audio...';
            loading.style.display = 'block';
            
            try {
                // Make request to TTS endpoint
                const response = await fetch('/generate-audio', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ text: text })
                });
                
                const data = await response.json();
                
                if (response.ok && data.audio_url) {
                    // Success - play the audio
                    console.log('TTS Audio URL received:', data.audio_url);
                    audioPlayer.src = data.audio_url;
                    audioInfo.textContent = `Text: "${data.text}" | Voice: ${data.voice} | Status: ${data.status}`;
                    result.style.display = 'block';
                    
                    // Auto-play the audio
                    try {
                        await audioPlayer.play();
                        console.log('TTS Audio playback started');
                    } catch (playError) {
                        console.log('Auto-play blocked by browser, user can click play manually:', playError);
                        // Add a message to let user know they can manually play
                        audioInfo.textContent += ' | Click the play button if it doesn\'t start automatically';
                    }
                } else {
                    // Error response
                    console.error('TTS API Error:', data);
                    showError(data.error || 'Something went wrong with the speech generation');
                }
            } catch (err) {
                showError('Connection problem: ' + err.message);
            } finally {
                // Reset button
                button.disabled = false;
                button.textContent = 'Make it Talk!';
                loading.style.display = 'none';
            }
        }
        
        function showError(message) {
            const error = document.getElementById('ttsError');
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.textContent = message;
            error.style.display = 'block';
        }
        
        function hideAllResults() {
            document.getElementById('ttsResult').style.display = 'none';
            document.getElementById('ttsError').style.display = 'none';
            document.getElementById('ttsLoading').style.display = 'none';
        }
        
        // Echo Bot functionality
        let mediaRecorder;
        let recordedChunks = [];
        let stream;
        let recordingStartTime;
        
        async function startRecording() {
            try {
                // Hide any previous errors
                document.getElementById('echoError').style.display = 'none';
                
                console.log('Requesting microphone access...');
                
                // Request microphone access
                stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                console.log('Microphone access granted');
                
                // Initialize MediaRecorder with better options
                let options = { mimeType: 'audio/webm; codecs=opus' };
                
                // Try different formats for better compatibility
                if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                    console.warn('webm/opus not supported, trying webm');
                    options = { mimeType: 'audio/webm' };
                }
                if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                    console.warn('webm not supported, trying mp4');
                    options = { mimeType: 'audio/mp4' };
                }
                if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                    console.warn('mp4 not supported, using default');
                    options = {};
                }
                
                console.log('Using MediaRecorder with options:', options);
                mediaRecorder = new MediaRecorder(stream, options);
                recordedChunks = [];
                
                console.log('MediaRecorder initialized');
                
                // Set up event handlers
                mediaRecorder.ondataavailable = function(event) {
                    console.log('Data available:', event.data.size, 'bytes');
                    if (event.data.size > 0) {
                        recordedChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = function() {
                    console.log('Recording stopped, processing audio...');
                    
                    // Create blob from recorded chunks
                    const blob = new Blob(recordedChunks, { type: 'audio/webm; codecs=opus' });
                    console.log('Audio blob created:', blob.size, 'bytes', 'Type:', blob.type);
                    
                    // Try different audio formats for better compatibility
                    let audioUrl;
                    try {
                        audioUrl = URL.createObjectURL(blob);
                        console.log('Audio URL created:', audioUrl);
                    } catch (error) {
                        console.error('Error creating audio URL:', error);
                        showEchoError('Error creating audio URL: ' + error.message);
                        return;
                    }
                    
                    // Set up audio playback
                    const audioElement = document.getElementById('recordedAudio');
                    audioElement.src = audioUrl;
                    
                    // Add event listeners to debug audio loading
                    audioElement.onloadstart = () => console.log('Audio loading started');
                    audioElement.onloadeddata = () => console.log('Audio data loaded');
                    audioElement.oncanplay = () => console.log('Audio can play');
                    audioElement.onerror = (e) => {
                        console.error('Audio error:', e);
                        showEchoError('Audio playback error. Try using a different browser or check your audio settings.');
                    };
                    
                    // Calculate and display duration and size
                    const duration = Date.now() - recordingStartTime;
                    const seconds = Math.floor(duration / 1000);
                    const minutes = Math.floor(seconds / 60);
                    const remainingSeconds = seconds % 60;
                    document.getElementById('recordingDuration').textContent = 
                        `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
                    
                    // Display file size
                    const sizeKB = Math.round(blob.size / 1024);
                    document.getElementById('recordingSize').textContent = `${sizeKB} KB`;
                    
                    // Store blob globally for download function
                    window.currentRecordingBlob = blob;
                    
                    // Show playback section
                    document.getElementById('playbackSection').style.display = 'block';
                    
                    // Stop all tracks to release microphone
                    stream.getTracks().forEach(track => track.stop());
                    
                    // Wait a moment then try to auto-play
                    setTimeout(() => {
                        audioElement.play().then(() => {
                            console.log('Audio playback started automatically');
                            // Auto-upload after successful recording
                            setTimeout(() => {
                                uploadRecording();
                            }, 1000); // Upload 1 second after playback starts
                        }).catch(error => {
                            console.warn('Auto-play blocked by browser:', error);
                            showEchoError('Got it! Your recording is ready. Just hit the play button to hear it back.');
                            // Still try to upload even if playback fails
                            setTimeout(() => {
                                uploadRecording();
                            }, 500);
                        });
                    }, 100);
                };
                
                // Start recording
                recordingStartTime = Date.now();
                mediaRecorder.start();
                
                console.log('Recording started');
                
                // Update UI
                document.getElementById('startRecordBtn').disabled = true;
                document.getElementById('stopRecordBtn').disabled = false;
                document.getElementById('recordingStatus').style.display = 'block';
                document.getElementById('playbackSection').style.display = 'none';
                
            } catch (error) {
                console.error('Recording error:', error);
                showEchoError('Microphone access denied or not available: ' + error.message);
            }
        }
        
        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
            }
            
            // Update UI
            document.getElementById('startRecordBtn').disabled = false;
            document.getElementById('stopRecordBtn').disabled = true;
            document.getElementById('recordingStatus').style.display = 'none';
        }
        
        function showEchoError(message) {
            const error = document.getElementById('echoError');
            const errorMessage = document.getElementById('echoErrorMessage');
            errorMessage.textContent = message;
            error.style.display = 'block';
        }
        
        function playRecording() {
            const audioElement = document.getElementById('recordedAudio');
            audioElement.currentTime = 0; // Reset to beginning
            audioElement.play().then(() => {
                console.log('Manual playback started');
            }).catch(error => {
                console.error('Manual playback failed:', error);
                showEchoError('Playback failed: ' + error.message);
            });
        }
        
        async function uploadRecording() {
            if (!window.currentRecordingBlob) {
                showUploadStatus('No recording available to upload', 'error');
                return;
            }
            
            const uploadBtn = document.getElementById('uploadBtn');
            const originalText = uploadBtn.textContent;
            
            try {
                // Update button state
                uploadBtn.disabled = true;
                uploadBtn.textContent = '‚è≥ Uploading...';
                
                // Show upload in progress
                showUploadStatus('Uploading audio to server...', 'loading');
                
                // Create FormData for file upload
                const formData = new FormData();
                formData.append('audio_file', window.currentRecordingBlob, 'recording.webm');
                
                // Upload to server
                const response = await fetch('/upload-audio', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok && result.status === 'success') {
                    // Success
                    console.log('Upload successful:', result);
                    showUploadStatus(
                        `‚úÖ Upload successful! File: ${result.filename} (${result.size_kb} KB)`, 
                        'success'
                    );
                } else {
                    // Error response
                    console.error('Upload error:', result);
                    showUploadStatus(`‚ùå Upload failed: ${result.detail || 'Unknown error'}`, 'error');
                }
                
            } catch (error) {
                console.error('Upload error:', error);
                showUploadStatus(`‚ùå Upload failed: ${error.message}`, 'error');
            } finally {
                // Reset button
                uploadBtn.disabled = false;
                uploadBtn.textContent = originalText;
            }
        }
        
        function showUploadStatus(message, type = 'info') {
            const statusDiv = document.getElementById('uploadStatus');
            const messageP = document.getElementById('uploadMessage');
            
            messageP.textContent = message;
            statusDiv.style.display = 'block';
            
            // Set colors based on status type
            switch(type) {
                case 'loading':
                    statusDiv.style.background = '#333';
                    statusDiv.style.border = '1px solid #007acc';
                    statusDiv.style.color = '#e0e0e0';
                    break;
                case 'success':
                    statusDiv.style.background = '#2a4d32';
                    statusDiv.style.border = '1px solid #27ae60';
                    statusDiv.style.color = '#27ae60';
                    break;
                case 'error':
                    statusDiv.style.background = '#4d2e1f';
                    statusDiv.style.border = '1px solid #f39c12';
                    statusDiv.style.color = '#f39c12';
                    break;
                default:
                    statusDiv.style.background = '#333';
                    statusDiv.style.border = '1px solid #666';
                    statusDiv.style.color = '#e0e0e0';
            }
        }
        
        function downloadRecording() {
            if (window.currentRecordingBlob) {
                const url = URL.createObjectURL(window.currentRecordingBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `recording_${new Date().toISOString().slice(0,19).replace(/:/g, '-')}.webm`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                console.log('Recording download started');
            } else {
                showEchoError('No recording available for download');
            }
        }
        
        // Check browser support on page load
        document.addEventListener('DOMContentLoaded', function() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showEchoError('Your browser does not support audio recording. Please use a modern browser like Chrome, Firefox, or Edge.');
                document.getElementById('startRecordBtn').disabled = true;
            }
        });
    </script>
</body>
</html>
